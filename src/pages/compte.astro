---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';

// Si d√©j√† connect√©, rediriger
if (Astro.locals.user) {
	return Astro.redirect('/modeles');
}
---

<Layout title="Mon compte - TaVue" description="Connecte-toi pour acc√©der √† tes cr√©ations.">
	<Header currentPage="compte" />
	
	<main class="min-h-[calc(100vh-100px)] bg-gradient-to-br from-blanc-casse to-beige-lin flex items-center justify-center p-8">
		<div class="card w-full max-w-[500px] overflow-hidden">
			<!-- Onglets -->
			<div class="flex border-b border-beige-lin">
				<button 
					class="tab-btn active flex-1 py-4 text-center font-medium transition-all" 
					data-tab="connexion"
				>
					Connexion
				</button>
				<button 
					class="tab-btn flex-1 py-4 text-center font-medium transition-all" 
					data-tab="inscription"
				>
					Cr√©er un compte
				</button>
			</div>
			
			<!-- Contenu Connexion -->
			<div class="p-12 tab-content" id="connexion-content">
				<h2 class="text-3xl font-semibold text-bleu-marine mb-3">Bienvenue.</h2>
				<p class="text-gris-taupe mb-8">Connecte-toi pour retrouver tes cr√©ations</p>
				
				<form id="login-form" class="space-y-6">
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Adresse email</label>
						<input 
							type="email" 
							name="email"
							placeholder="ton@email.fr" 
							class="input-field"
							required
						/>
					</div>
					
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Mot de passe</label>
						<input 
							type="password" 
							name="password"
							placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
							class="input-field"
							required
						/>
					</div>
					
					<button type="submit" class="btn-primary w-full py-4 mt-3">
						Se connecter
					</button>
				</form>
				
				<p id="login-status" class="mt-4 text-center text-sm"></p>
				
				<!-- Nudge -->
				<div class="mt-6 bg-beige-lin p-4 rounded-lg text-center">
					<p class="text-sm font-semibold text-bleu-marine mb-1">üí° Ta cr√©ation t'attend !</p>
					<p class="text-sm text-gris-taupe">Enregistre-la en 1 minute pour ne pas la perdre.</p>
				</div>
			</div>
			
			<!-- Contenu Inscription -->
			<div class="p-12 tab-content hidden" id="inscription-content">
				<h2 class="text-3xl font-semibold text-bleu-marine mb-3">Rejoins-nous.</h2>
				<p class="text-gris-taupe mb-8">Cr√©e ton compte en 1 minute</p>
				
				<form id="signup-form" class="space-y-6">
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Nom complet</label>
						<input 
							type="text" 
							name="name"
							placeholder="Jean Dupont" 
							class="input-field"
							required
						/>
					</div>
					
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Adresse email</label>
						<input 
							type="email" 
							name="email"
							placeholder="ton@email.fr" 
							class="input-field"
							required
						/>
					</div>
					
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Mot de passe</label>
						<input 
							type="password" 
							name="password"
							placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
							class="input-field"
							minlength="8"
							required
						/>
					</div>
					
					<div>
						<label class="block text-sm font-medium text-bleu-marine mb-2">Confirmer le mot de passe</label>
						<input 
							type="password" 
							name="passwordConfirm"
							placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
							class="input-field"
							minlength="8"
							required
						/>
					</div>
					
					<button type="submit" class="btn-primary w-full py-4 mt-3">
						Cr√©er mon compte
					</button>
				</form>
				
				<p id="signup-status" class="mt-4 text-center text-sm"></p>
				
				<!-- Nudge -->
				<div class="mt-6 bg-beige-lin p-4 rounded-lg text-center">
					<p class="text-sm font-semibold text-bleu-marine mb-1">üí° Ta cr√©ation t'attend !</p>
					<p class="text-sm text-gris-taupe">Enregistre-la en 1 minute pour ne pas la perdre.</p>
				</div>
			</div>
		</div>
	</main>
</Layout>

<style>
	.tab-btn {
		@apply text-gris-taupe bg-blanc-casse;
	}
	
	.tab-btn.active {
		@apply text-bleu-marine bg-white font-semibold;
	}
</style>

<script>
	// Gestion des onglets
	document.querySelectorAll('.tab-btn').forEach(btn => {
		btn.addEventListener('click', () => {
			const tab = btn.getAttribute('data-tab');
			
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.add('hidden');
			});
			document.getElementById(`${tab}-content`)?.classList.remove('hidden');
		});
	});
	
	// Connexion
	const loginForm = document.getElementById('login-form');
	const loginStatus = document.getElementById('login-status');

	loginForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		loginStatus.textContent = 'Connexion...';
		loginStatus.className = 'mt-4 text-center text-sm text-bleu-marine';
		
		const formData = new FormData(loginForm);

		try {
			const res = await fetch('/api/login', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					email: formData.get('email'),
					password: formData.get('password')
				}),
				credentials: 'include'
			});

			if (res.ok) {
				const data = await res.json();
				localStorage.setItem('user', JSON.stringify(data.user));
				loginStatus.textContent = '‚úÖ Connexion r√©ussie !';
				loginStatus.className = 'mt-4 text-center text-sm text-green-600';
				setTimeout(() => window.location.href = '/modeles', 500);
			} else {
				loginStatus.textContent = '‚ùå Email ou mot de passe invalide';
				loginStatus.className = 'mt-4 text-center text-sm text-red-600';
			}
		} catch (error) {
			console.error('Erreur:', error);
			loginStatus.textContent = '‚ùå Erreur de connexion';
			loginStatus.className = 'mt-4 text-center text-sm text-red-600';
		}
	});

	// Inscription
	const signupForm = document.getElementById('signup-form');
	const signupStatus = document.getElementById('signup-status');

	signupForm?.addEventListener('submit', async (e) => {
		e.preventDefault();
		signupStatus.textContent = 'Cr√©ation du compte...';
		signupStatus.className = 'mt-4 text-center text-sm text-bleu-marine';
		
		const formData = new FormData(signupForm);
		const password = formData.get('password');
		const passwordConfirm = formData.get('passwordConfirm');

		if (password !== passwordConfirm) {
			signupStatus.textContent = '‚ùå Les mots de passe ne correspondent pas';
			signupStatus.className = 'mt-4 text-center text-sm text-red-600';
			return;
		}

		try {
			const res = await fetch('/api/signup', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					name: formData.get('name'),
					email: formData.get('email'),
					password: formData.get('password'),
					passwordConfirm: formData.get('passwordConfirm')
				})
			});

			const data = await res.json();

			if (res.ok) {
				signupStatus.textContent = '‚úÖ Compte cr√©√© ! Connexion...';
				signupStatus.className = 'mt-4 text-center text-sm text-green-600';
				
				// Auto-login
				const loginRes = await fetch('/api/login', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						email: formData.get('email'),
						password: formData.get('password')
					}),
					credentials: 'include'
				});

				if (loginRes.ok) {
					const loginData = await loginRes.json();
					localStorage.setItem('user', JSON.stringify(loginData.user));
					setTimeout(() => window.location.href = '/configurateur', 500);
				}
			} else {
				signupStatus.textContent = '‚ùå ' + (data.error || 'Erreur lors de la cr√©ation');
				signupStatus.className = 'mt-4 text-center text-sm text-red-600';
			}
		} catch (error) {
			console.error('Erreur:', error);
			signupStatus.textContent = '‚ùå Erreur de connexion au serveur';
			signupStatus.className = 'mt-4 text-center text-sm text-red-600';
		}
	});
</script>