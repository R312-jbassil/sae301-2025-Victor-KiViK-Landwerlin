---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import pb from '../utils/pb';

// R√©cup√©rer l'ID depuis les query params
const url = new URL(Astro.request.url);
const id = url.searchParams.get('id');

// Rediriger si pas d'ID
if (!id) {
	return Astro.redirect('/modeles');
}

// R√©cup√©rer les donn√©es de la cr√©ation
let creation;
try {
	creation = await pb.collection('lunettes').getOne(id);
} catch (error) {
	console.error('Erreur chargement cr√©ation:', error);
	return Astro.redirect('/modeles');
}

// V√©rifier que l'utilisateur a acc√®s (propri√©taire)
const user = Astro.locals.user;
if (!user || creation.user !== user.id) {
	return Astro.redirect('/modeles');
}
---

<Layout title={`${creation.nom} - TaVue`} description={`Votre cr√©ation personnalis√©e : ${creation.nom}`}>
	<Header currentPage="modeles" />
	
	<main class="p-20 bg-blanc-casse">
		<!-- Breadcrumb -->
		<nav class="text-sm text-gris-taupe mb-8">
			<a href="/" class="hover:text-bleu-marine transition-colors">Accueil</a>
			<span class="mx-2">/</span>
			<a href="/modeles" class="hover:text-bleu-marine transition-colors">Mes cr√©ations</a>
			<span class="mx-2">/</span>
			<span class="text-bleu-marine">{creation.nom}</span>
		</nav>
		
		<!-- Grille principale -->
		<div class="grid grid-cols-2 gap-20 mb-20">
			<!-- Visuel produit -->
			<div class="card p-16 flex items-center justify-center">
				<div class="w-full max-w-[600px]" set:html={creation.svg_data}>
				</div>
			</div>
			
			<!-- Informations produit -->
			<div>
				<!-- Badge -->
				<span class="inline-block bg-brun-clair text-white text-xs font-semibold uppercase tracking-wider px-3 py-1.5 rounded-md mb-6">
					Votre cr√©ation
				</span>
				
				<h1 class="text-4xl font-semibold text-bleu-marine mb-4">{creation.nom}</h1>
				<p class="text-3xl font-semibold text-brun-clair mb-6">{creation.prix} ‚Ç¨</p>
				
				<p class="text-gris-taupe leading-relaxed mb-8">
					Votre monture personnalis√©e en {creation.materiau}, couleur {creation.couleur}. 
					Chaque paire est assembl√©e √† la main dans notre atelier parisien. Le pont de {creation.pont} mm 
					et les verres de {creation.verres} mm garantissent un confort optimal tout au long de la journ√©e.
				</p>
				
				<!-- Caract√©ristiques -->
				<div class="bg-beige-lin p-6 rounded-xl mb-8">
					<h3 class="text-sm font-semibold uppercase tracking-wider text-bleu-marine mb-4">Caract√©ristiques</h3>
					<div class="space-y-3">
						<div class="flex justify-between py-3 border-b border-brun-clair/20">
							<span class="text-gris-taupe">Mat√©riau</span>
							<span class="font-semibold text-bleu-marine capitalize">{creation.materiau}</span>
						</div>
						<div class="flex justify-between py-3 border-b border-brun-clair/20">
							<span class="text-gris-taupe">Largeur du pont</span>
							<span class="font-semibold text-bleu-marine">{creation.pont} mm</span>
						</div>
						<div class="flex justify-between py-3 border-b border-brun-clair/20">
							<span class="text-gris-taupe">Taille des verres</span>
							<span class="font-semibold text-bleu-marine">{creation.verres} mm</span>
						</div>
						<div class="flex justify-between py-3 border-b border-brun-clair/20">
							<span class="text-gris-taupe">Couleur</span>
							<span class="font-semibold text-bleu-marine">{creation.couleur}</span>
						</div>
						<div class="flex justify-between py-3 border-b border-brun-clair/20">
							<span class="text-gris-taupe">Type de verres</span>
							<span class="font-semibold text-bleu-marine capitalize">{creation.type_verre}</span>
						</div>
						<div class="flex justify-between py-3">
							<span class="text-gris-taupe">Origine</span>
							<span class="font-semibold text-bleu-marine">Fabriqu√© √† Paris</span>
						</div>
					</div>
				</div>
				
				<!-- Boutons d'action -->
				<div class="grid grid-cols-[2fr_1fr] gap-4 mb-8">
					<button class="btn-primary py-4 flex items-center justify-center gap-2">
						<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
						</svg>
						Ajouter au panier
					</button>
					<a href="/configurateur" class="border-2 border-bleu-marine text-bleu-marine py-4 rounded-lg hover:bg-bleu-marine hover:text-white transition-all text-center flex items-center justify-center">
						Modifier
					</a>
				</div>
				
				<!-- Actions suppl√©mentaires -->
				<div class="flex gap-3">
					<button id="delete-btn" data-id={creation.id} class="flex-1 py-3 border-2 border-red-500 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition-all">
						üóëÔ∏è Supprimer
					</button>
					<button id="duplicate-btn" data-id={creation.id} class="flex-1 py-3 border-2 border-bleu-marine text-bleu-marine rounded-lg hover:bg-bleu-marine hover:text-white transition-all">
						üìã Dupliquer
					</button>
				</div>
			</div>
		</div>
		
		<!-- CTA retour -->
		<section class="text-center py-12">
			<a href="/modeles" class="text-bleu-marine hover:text-brun-clair transition-colors font-medium">
				‚Üê Retour √† mes cr√©ations
			</a>
		</section>
	</main>
</Layout>

<script>
	// Suppression
	document.getElementById('delete-btn')?.addEventListener('click', async (e) => {
		const id = e.currentTarget.dataset.id;
		if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette cr√©ation ?')) return;
		
		try {
			const res = await fetch(`/api/deleteLunettes`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				credentials: 'include',
				body: JSON.stringify({ id })
			});
			
			if (res.ok) {
				alert('‚úÖ Cr√©ation supprim√©e');
				window.location.href = '/modeles';
			} else {
				throw new Error('Erreur de suppression');
			}
		} catch (error) {
			console.error(error);
			alert('‚ùå Erreur lors de la suppression');
		}
	});
	
	// Duplication
	document.getElementById('duplicate-btn')?.addEventListener('click', async (e) => {
		const id = e.currentTarget.dataset.id;
		const newName = prompt('Nom de la copie :');
		if (!newName) return;
		
		try {
			const res = await fetch(`/api/duplicateLunettes`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				credentials: 'include',
				body: JSON.stringify({ id, newName })
			});
			
			const data = await res.json();
			
			if (data.success) {
				alert('‚úÖ Cr√©ation dupliqu√©e');
				window.location.href = `/produit?id=${data.newId}`;
			} else {
				throw new Error(data.error);
			}
		} catch (error) {
			console.error(error);
			alert('‚ùå Erreur lors de la duplication');
		}
	});
</script>